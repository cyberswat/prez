<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en"><head>
<body>


<link type="text/css" rel="stylesheet" href="assets/sh.css">
<div style="font-size: 12px;">
<div class="syntaxhighlighter" id="highlighter_603407"><div class="bar show"><div class="toolbar"><a class="item viewSource" style="width: 16px; height: 16px;" title="view source" href="#viewSource">view source</a><a class="item printSource" style="width: 16px; height: 16px;" title="print" href="#printSource">print</a><a class="item about" style="width: 16px; height: 16px;" title="?" href="#about">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>001</code></td><td class="content"><code class="comments">#!/bin/bash</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>002</code></td><td class="content"><code class="comments">#</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>003</code></td><td class="content"><code class="comments"># StackScript Bash Library</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>004</code></td><td class="content"><code class="comments">#</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>005</code></td><td class="content"><code class="comments"># Copyright (c) 2010 Linode LLC / Christopher S. Aker &lt;caker@linode.com&gt;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>006</code></td><td class="content"><code class="comments"># All rights reserved.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>007</code></td><td class="content"><code class="comments">#</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>008</code></td><td class="content"><code class="comments"># Redistribution and use in source and binary forms, with or without modification, </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>009</code></td><td class="content"><code class="comments"># are permitted provided that the following conditions are met:</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>010</code></td><td class="content"><code class="comments">#</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>011</code></td><td class="content"><code class="comments"># * Redistributions of source code must retain the above copyright notice, this</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>012</code></td><td class="content"><code class="comments"># list of conditions and the following disclaimer.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>013</code></td><td class="content"><code class="comments">#</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>014</code></td><td class="content"><code class="comments"># * Redistributions in binary form must reproduce the above copyright notice, this</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>015</code></td><td class="content"><code class="comments"># list of conditions and the following disclaimer in the documentation and/or</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>016</code></td><td class="content"><code class="comments"># other materials provided with the distribution.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>017</code></td><td class="content"><code class="comments">#</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>018</code></td><td class="content"><code class="comments"># * Neither the name of Linode LLC nor the names of its contributors may be</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>019</code></td><td class="content"><code class="comments"># used to endorse or promote products derived from this software without specific prior</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>020</code></td><td class="content"><code class="comments"># written permission.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>021</code></td><td class="content"><code class="comments">#</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>022</code></td><td class="content"><code class="comments"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>023</code></td><td class="content"><code class="comments"># EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>024</code></td><td class="content"><code class="comments"># OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>025</code></td><td class="content"><code class="comments"># SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>026</code></td><td class="content"><code class="comments"># INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>027</code></td><td class="content"><code class="comments"># TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>028</code></td><td class="content"><code class="comments"># BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>029</code></td><td class="content"><code class="comments"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>030</code></td><td class="content"><code class="comments"># ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>031</code></td><td class="content"><code class="comments"># DAMAGE.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>032</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>033</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>034</code></td><td class="content"><code class="comments"># System</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>035</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>036</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>037</code></td><td class="content"><code class="keyword">function</code> <code class="plain">system_update {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>038</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">apt-get update</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>039</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">apt-get -y </code><code class="functions">install</code> <code class="plain">aptitude</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>040</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">aptitude -y full-upgrade</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>041</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>042</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>043</code></td><td class="content"><code class="keyword">function</code> <code class="plain">system_primary_ip {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>044</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># returns the primary IP assigned to eth0</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>045</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">$(</code><code class="functions">ifconfig</code> <code class="plain">eth0 | </code><code class="functions">awk</code> <code class="plain">-F: </code><code class="string">'/inet addr:/ {print $2}'</code> <code class="plain">| </code><code class="functions">awk</code> <code class="string">'{ print $1 }'</code><code class="plain">)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>046</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>047</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>048</code></td><td class="content"><code class="keyword">function</code> <code class="plain">get_rdns {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>049</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># calls host on an IP address and returns its reverse dns</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>050</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>051</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -e /usr/bin/host ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>052</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">aptitude -y </code><code class="functions">install</code> <code class="plain">dnsutils &gt; /dev/null</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>053</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>054</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">$(host $1 | </code><code class="functions">awk</code> <code class="string">'/pointer/ {print $5}'</code> <code class="plain">| </code><code class="functions">sed</code> <code class="string">'s/\.$//'</code><code class="plain">)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>055</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>056</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>057</code></td><td class="content"><code class="keyword">function</code> <code class="plain">get_rdns_primary_ip {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>058</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># returns the reverse dns of the primary IP assigned to this system</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>059</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">$(get_rdns $(system_primary_ip))</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>060</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>061</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>062</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>063</code></td><td class="content"><code class="comments"># Postfix</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>064</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>065</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>066</code></td><td class="content"><code class="keyword">function</code> <code class="plain">postfix_install_loopback_only {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>067</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Installs postfix and configure to listen only on the local interface. Also</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>068</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># allows for local mail delivery</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>069</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>070</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"postfix postfix/main_mailer_type </code><code class="functions">select</code> <code class="plain">Internet Site" | debconf-</code><code class="functions">set</code><code class="plain">-selections</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>071</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"postfix postfix/mailname string localhost" | debconf-</code><code class="functions">set</code><code class="plain">-selections</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>072</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"postfix postfix/destinations string localhost.localdomain, localhost" | debconf-</code><code class="functions">set</code><code class="plain">-selections</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>073</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">aptitude -y </code><code class="functions">install</code> <code class="plain">postfix</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>074</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">/usr/sbin/postconf -e "inet_interfaces = loopback-only"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>075</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments">#/usr/sbin/postconf -e "local_transport = error:local delivery is disabled"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>076</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>077</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">touch</code> <code class="plain">/tmp/restart-postfix</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>078</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>079</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>080</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>081</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>082</code></td><td class="content"><code class="comments"># Apache</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>083</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>084</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>085</code></td><td class="content"><code class="keyword">function</code> <code class="plain">apache_install {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>086</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># installs the system default apache2 MPM</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>087</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">aptitude -y </code><code class="functions">install</code> <code class="plain">apache2</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>088</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>089</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">a2dissite default </code><code class="comments"># disable the interfering default virtualhost</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>090</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>091</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># clean up, or add the NameVirtualHost line to ports.conf</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>092</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i -e </code><code class="string">'s/^NameVirtualHost \*$/NameVirtualHost *:80/'</code> <code class="plain">/etc/apache2/ports.conf</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>093</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">! </code><code class="functions">grep</code> <code class="plain">-q NameVirtualHost /etc/apache2/ports.conf; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>094</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="string">'NameVirtualHost *:80'</code> <code class="plain">&gt; /etc/apache2/ports.conf.tmp</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>095</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">cat</code> <code class="plain">/etc/apache2/ports.conf &gt;&gt; /etc/apache2/ports.conf.tmp</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>096</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">mv</code> <code class="plain">-f /etc/apache2/ports.conf.tmp /etc/apache2/ports.conf</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>097</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>098</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>099</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>100</code></td><td class="content"><code class="keyword">function</code> <code class="plain">apache_tune {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>101</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Tunes Apache's memory to use the percentage of RAM you specify, defaulting to 40%</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>102</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>103</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $1 - the percent of system memory to allocate towards Apache</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>104</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>105</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ];</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>106</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">then</code> <code class="plain">PERCENT=40</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>107</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">else</code> <code class="plain">PERCENT="$1"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>108</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>109</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>110</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">aptitude -y </code><code class="functions">install</code> <code class="plain">apache2-mpm-prefork</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>111</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">PERPROCMEM=10 </code><code class="comments"># the amount of memory in MB each apache process is likely to utilize</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>112</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">MEM=$(</code><code class="functions">grep</code> <code class="plain">MemTotal /proc/meminfo | </code><code class="functions">awk</code> <code class="string">'{ print int($2/1024) }'</code><code class="plain">) </code><code class="comments"># how much memory in MB this system has</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>113</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">MAXCLIENTS=$((MEM*PERCENT/100/PERPROCMEM)) </code><code class="comments"># calculate MaxClients</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>114</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">MAXCLIENTS=${MAXCLIENTS/.*} </code><code class="comments"># cast to an integer</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>115</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i -e "s/\(^[ \t]*MaxClients[ \t]*\)[0-9]*/\1$MAXCLIENTS/" /etc/apache2/apache2.conf</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>116</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>117</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">touch</code> <code class="plain">/tmp/restart-apache2</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>118</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>119</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>120</code></td><td class="content"><code class="keyword">function</code> <code class="plain">apache_virtualhost {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>121</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Configures a VirtualHost</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>122</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>123</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $1 - required - the hostname of the virtualhost to create </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>124</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>125</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>126</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"apache_virtualhost() requires the </code><code class="functions">hostname</code> <code class="plain">as the first argument"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>127</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>128</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>129</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>130</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ -e "/etc/apache2/sites-available/$1" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>131</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">/etc/apache2/sites-available/$1 already exists</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>132</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code><code class="plain">;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>133</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>134</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>135</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">mkdir</code> <code class="plain">-p /srv/www/$1/public_html /srv/www/$1/logs</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>136</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>137</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"&lt;VirtualHost *:80&gt;" &gt; /etc/apache2/sites-available/$1</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>138</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"&nbsp;&nbsp;&nbsp; ServerName $1" &gt;&gt; /etc/apache2/sites-available/$1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>139</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"&nbsp;&nbsp;&nbsp; DocumentRoot /srv/www/$1/public_html/" &gt;&gt; /etc/apache2/sites-available/$1</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>140</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"&nbsp;&nbsp;&nbsp; ErrorLog /srv/www/$1/logs/error.log" &gt;&gt; /etc/apache2/sites-available/$1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>141</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"&nbsp;&nbsp;&nbsp; CustomLog /srv/www/$1/logs/access.log combined" &gt;&gt; /etc/apache2/sites-available/$1</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>142</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"&lt;/VirtualHost&gt;" &gt;&gt; /etc/apache2/sites-available/$1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>143</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>144</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">a2ensite $1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>145</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>146</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">touch</code> <code class="plain">/tmp/restart-apache2</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>147</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>148</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>149</code></td><td class="content"><code class="keyword">function</code> <code class="plain">apache_virtualhost_from_rdns {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>150</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Configures a VirtualHost using the rdns of the first IP as the ServerName</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>151</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>152</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">apache_virtualhost $(get_rdns_primary_ip)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>153</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>154</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>155</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>156</code></td><td class="content"><code class="keyword">function</code> <code class="plain">apache_virtualhost_get_docroot {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>157</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>158</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"apache_virtualhost_get_docroot() requires the </code><code class="functions">hostname</code> <code class="plain">as the first argument"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>159</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>160</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>161</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>162</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ -e /etc/apache2/sites-available/$1 ];</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>163</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">then</code> <code class="functions">echo</code> <code class="plain">$(</code><code class="functions">awk</code> <code class="string">'/DocumentRoot/ {print $2}'</code> <code class="plain">/etc/apache2/sites-available/$1 )</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>164</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>165</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>166</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>167</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>168</code></td><td class="content"><code class="comments"># mysql-server</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>169</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>170</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>171</code></td><td class="content"><code class="keyword">function</code> <code class="plain">mysql_install {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>172</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $1 - the mysql root password</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>173</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>174</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>175</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_install() requires the root pass as its first argument"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>176</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>177</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>178</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>179</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql-server-5.1 mysql-server/root_password password $1" | debconf-</code><code class="functions">set</code><code class="plain">-selections</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>180</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql-server-5.1 mysql-server/root_password_again password $1" | debconf-</code><code class="functions">set</code><code class="plain">-selections</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>181</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">apt-get -y </code><code class="functions">install</code> <code class="plain">mysql-server mysql-client</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>182</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>183</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"Sleeping </code><code class="keyword">while</code> <code class="plain">MySQL starts up </code><code class="keyword">for</code> <code class="plain">the first </code><code class="functions">time</code><code class="plain">..."</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>184</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sleep</code> <code class="plain">5</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>185</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>186</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>187</code></td><td class="content"><code class="keyword">function</code> <code class="plain">mysql_tune {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>188</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Tunes MySQL's memory usage to utilize the percentage of memory you specify, defaulting to 40%</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>189</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>190</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $1 - the percent of system memory to allocate towards MySQL</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>191</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>192</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ];</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>193</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">then</code> <code class="plain">PERCENT=40</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>194</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">else</code> <code class="plain">PERCENT="$1"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>195</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>196</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>197</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i -e </code><code class="string">'s/^#skip-innodb/skip-innodb/'</code> <code class="plain">/etc/mysql/my.cnf # disable innodb - saves about 100M</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>198</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>199</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">MEM=$(</code><code class="functions">awk</code> <code class="string">'/MemTotal/ {print int($2/1024)}'</code> <code class="plain">/proc/meminfo) </code><code class="comments"># how much memory in MB this system has</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>200</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">MYMEM=$((MEM*PERCENT/100)) </code><code class="comments"># how much memory we'd like to tune mysql with</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>201</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">MYMEMCHUNKS=$((MYMEM/4)) </code><code class="comments"># how many 4MB chunks we have to play with</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>202</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>203</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># mysql config options we want to set to the percentages in the second list, respectively</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>204</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">OPTLIST=(key_buffer sort_buffer_size read_buffer_size read_rnd_buffer_size myisam_sort_buffer_size query_cache_size)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>205</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">DISTLIST=(75 1 1 1 5 15)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>206</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>207</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">for</code> <code class="plain">opt </code><code class="keyword">in</code> <code class="plain">${OPTLIST[@]}; </code><code class="keyword">do</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>208</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i -e "/\[mysqld\]/,/\[.*\]/s/^$opt/</code><code class="comments">#$opt/" /etc/mysql/my.cnf</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>209</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">done</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>210</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>211</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">for</code> <code class="plain">i </code><code class="keyword">in</code> <code class="plain">${!OPTLIST[*]}; </code><code class="keyword">do</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>212</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">val=$(</code><code class="functions">echo</code> <code class="plain">| </code><code class="functions">awk</code> <code class="plain">"{print int((${DISTLIST[$i]} * $MYMEMCHUNKS/100))*4}")</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>213</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ $val -</code><code class="keyword">lt</code> <code class="plain">4 ]</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>214</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">then</code> <code class="plain">val=4</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>215</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>216</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">config="${config}\n${OPTLIST[$i]} = ${val}M"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>217</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">done</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>218</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>219</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i -e "s/\(\[mysqld\]\)/\1\n$config\n/" /etc/mysql/my.cnf</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>220</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>221</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">touch</code> <code class="plain">/tmp/restart-mysql</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>222</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>223</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>224</code></td><td class="content"><code class="keyword">function</code> <code class="plain">mysql_create_database {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>225</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $1 - the mysql root password</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>226</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $2 - the db name to create</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>227</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>228</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>229</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_create_database() requires the root pass as its first argument"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>230</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>231</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>232</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$2" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>233</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_create_database() requires the name of the database as the second argument"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>234</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>235</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>236</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>237</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"CREATE DATABASE $2;" | mysql -u root -p$1</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>238</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>239</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>240</code></td><td class="content"><code class="keyword">function</code> <code class="plain">mysql_create_user {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>241</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $1 - the mysql root password</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>242</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $2 - the user to create</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>243</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $3 - their password</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>244</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>245</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>246</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_create_user() requires the root pass as its first argument"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>247</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>248</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>249</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$2" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>250</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_create_user() requires username as the second argument"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>251</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>252</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>253</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$3" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>254</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_create_user() requires a password as the third argument"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>255</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>256</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>257</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>258</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"CREATE USER </code><code class="string">'$2'</code><code class="plain">@</code><code class="string">'localhost'</code> <code class="plain">IDENTIFIED BY </code><code class="string">'$3'</code><code class="plain">;" | mysql -u root -p$1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>259</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>260</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>261</code></td><td class="content"><code class="keyword">function</code> <code class="plain">mysql_grant_user {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>262</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $1 - the mysql root password</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>263</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $2 - the user to bestow privileges </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>264</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $3 - the database</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>265</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>266</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>267</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_create_user() requires the root pass as its first argument"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>268</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>269</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>270</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$2" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>271</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_create_user() requires username as the second argument"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>272</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>273</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>274</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$3" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>275</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"mysql_create_user() requires a database as the third argument"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>276</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>277</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>278</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>279</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"GRANT ALL PRIVILEGES ON $3.* TO </code><code class="string">'$2'</code><code class="plain">@</code><code class="string">'localhost'</code><code class="plain">;" | mysql -u root -p$1</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>280</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"FLUSH PRIVILEGES;" | mysql -u root -p$1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>281</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>282</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>283</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>284</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>285</code></td><td class="content"><code class="comments"># PHP functions</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>286</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>287</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>288</code></td><td class="content"><code class="keyword">function</code> <code class="plain">php_install_with_apache {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>289</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">aptitude -y </code><code class="functions">install</code> <code class="plain">php5 php5-mysql libapache2-mod-php5</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>290</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">touch</code> <code class="plain">/tmp/restart-apache2</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>291</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>292</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>293</code></td><td class="content"><code class="keyword">function</code> <code class="plain">php_tune {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>294</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Tunes PHP to utilize up to 32M per process</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>295</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>296</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i</code><code class="string">'-orig'</code> <code class="string">'s/memory_limit = [0-9]\+M/memory_limit = 32M/'</code> <code class="plain">/etc/php5/apache2/php.ini</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>297</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">touch</code> <code class="plain">/tmp/restart-apache2</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>298</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>299</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>300</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>301</code></td><td class="content"><code class="comments"># Wordpress functions</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>302</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>303</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>304</code></td><td class="content"><code class="keyword">function</code> <code class="plain">wordpress_install {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>305</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># installs the latest wordpress tarball from wordpress.org</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>306</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>307</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># $1 - required - The existing virtualhost to install into</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>308</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>309</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>310</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"wordpress_install() requires the vitualhost as its first argument"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>311</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>312</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>313</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>314</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -e /usr/bin/wget ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>315</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">aptitude -y </code><code class="functions">install</code> <code class="plain">wget</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>316</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>317</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>318</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">VPATH=$(apache_virtualhost_get_docroot $1)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>319</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>320</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$VPATH" ]; </code><code class="keyword">then</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>321</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">"Could not determine DocumentRoot </code><code class="keyword">for</code> <code class="plain">$1"</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>322</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">return</code> <code class="plain">1;</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>323</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>324</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>325</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># download, extract, chown, and get our config file started</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>326</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">cd</code> <code class="plain">$VPATH</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>327</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">wget <a href="http://wordpress.org/latest.">http://wordpress.org/latest.</a></code><code class="functions">tar</code><code class="plain">.gz</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>328</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">tar</code> <code class="plain">xfz latest.</code><code class="functions">tar</code><code class="plain">.gz</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>329</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">chown</code> <code class="plain">-R www-data: wordpress/</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>330</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">cd</code> <code class="plain">$VPATH/wordpress</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>331</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">cp</code> <code class="plain">wp-config-sample.php wp-config.php</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>332</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">chown</code> <code class="plain">www-data wp-config.php</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>333</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">chmod</code> <code class="plain">640 wp-config.php</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>334</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>335</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># database configuration</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>336</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">WPPASS=$(randomString 20)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>337</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">mysql_create_database "$DB_PASSWORD" wordpress</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>338</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">mysql_create_user "$DB_PASSWORD" wordpress "$WPPASS"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>339</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">mysql_grant_user "$DB_PASSWORD" wordpress wordpress</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>340</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>341</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># configuration file updates</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>342</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">for</code> <code class="plain">i </code><code class="keyword">in</code> <code class="plain">{1..4}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>343</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">do</code> <code class="functions">sed</code> <code class="plain">-i "0,/put your unique phrase here/s/put your unique phrase here/$(randomString 50)/" wp-config.php</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>344</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">done</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>345</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>346</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i </code><code class="string">'s/database_name_here/wordpress/'</code> <code class="plain">wp-config.php</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>347</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i </code><code class="string">'s/username_here/wordpress/'</code> <code class="plain">wp-config.php</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>348</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i "s/password_here/$WPPASS/" wp-config.php</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>349</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>350</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># <a href="http://downloads.wordpress.org/plugin/wp-super-cache.0.9.8.zip">http://downloads.wordpress.org/plugin/wp-super-cache.0.9.8.zip</a></code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>351</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>352</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>353</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>354</code></td><td class="content"><code class="comments"># Other niceties!</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>355</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>356</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>357</code></td><td class="content"><code class="keyword">function</code> <code class="plain">goodstuff {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>358</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Installs the REAL vim, wget, less, and enables color root prompt and the "ll" list long alias</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>359</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>360</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">aptitude -y </code><code class="functions">install</code> <code class="plain">wget vim </code><code class="functions">less</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>361</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i -e </code><code class="string">'s/^#PS1=/PS1=/'</code> <code class="plain">/root/.bashrc # </code><code class="functions">enable</code> <code class="plain">the colorful root </code><code class="functions">bash</code> <code class="plain">prompt</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>362</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">sed</code> <code class="plain">-i -e "s/^</code><code class="comments">#alias ll='ls -l'/alias ll='ls -al'/" /root/.bashrc # enable ll list long alias &lt;3</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>363</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>364</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>365</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>366</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>367</code></td><td class="content"><code class="comments"># utility functions</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>368</code></td><td class="content"><code class="comments">###########################################################</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>369</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>370</code></td><td class="content"><code class="keyword">function</code> <code class="plain">restartServices {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>371</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># restarts services that have a file in /tmp/needs-restart/</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>372</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>373</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">for</code> <code class="plain">service </code><code class="keyword">in</code> <code class="plain">$(</code><code class="functions">ls</code> <code class="plain">/tmp/restart-* | </code><code class="functions">cut</code> <code class="plain">-d- -f2-10); </code><code class="keyword">do</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>374</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">/etc/init.d/$service restart</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>375</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">rm</code> <code class="plain">-f /tmp/restart-$service</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>376</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">done</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>377</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>378</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>379</code></td><td class="content"><code class="keyword">function</code> <code class="plain">randomString {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>380</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">if</code> <code class="plain">[ ! -n "$1" ];</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>381</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">then</code> <code class="plain">LEN=20</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>382</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">else</code> <code class="plain">LEN="$1"</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>383</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">fi</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>384</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>385</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">echo</code> <code class="plain">$(&lt;/dev/urandom </code><code class="functions">tr</code> <code class="plain">-</code><code class="functions">dc</code> <code class="plain">A-Za-z0-9 | </code><code class="functions">head</code> <code class="plain">-c $LEN) </code><code class="comments"># generate a random string</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>386</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div></div>
</div>


</body></html>